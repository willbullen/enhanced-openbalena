global
    daemon
    log stdout local0
    chroot /var/lib/haproxy
    stats socket /var/lib/haproxy/stats
    user haproxy
    group haproxy

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option log-health-checks
    option forwardfor
    option http-server-close
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

# Stats page
frontend stats
    bind *:1936
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# Main frontend
frontend main
    bind *:80
    
    # ACL rules for routing
    acl is_api path_beg /api/
    acl is_admin path_beg /admin/
    acl is_registry hdr(host) -i registry.openbalena.local
    acl is_vpn hdr(host) -i vpn.openbalena.local
    acl is_s3 hdr(host) -i s3.openbalena.local
    
    # Route to appropriate backends
    use_backend openbalena_api if is_api or is_admin
    use_backend openbalena_registry if is_registry
    use_backend openbalena_vpn if is_vpn
    use_backend openbalena_s3 if is_s3
    default_backend web_interface

# Web interface backend (React + Django)
backend web_interface
    balance roundrobin
    option httpchk GET /
    server web1 web-interface:8000 check

# OpenBalena API backend
backend openbalena_api
    balance roundrobin
    option httpchk GET /ping
    server api1 api:1337 check

# OpenBalena Registry backend
backend openbalena_registry
    balance roundrobin
    option httpchk GET /v2/
    server registry1 registry:2375 check

# OpenBalena VPN backend
backend openbalena_vpn
    mode tcp
    balance roundrobin
    server vpn1 vpn:443 check

# OpenBalena S3 backend
backend openbalena_s3
    balance roundrobin
    option httpchk GET /
    server s3_1 s3:9000 check
